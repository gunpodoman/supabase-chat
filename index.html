<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supabase ì‹¤ì‹œê°„ ì‹œìŠ¤í…œ</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;700&display=swap');
        body { font-family: 'Pretendard', sans-serif; background: #f1f5f9; }
        .hidden { display: none !important; }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <div id="app" class="w-full max-w-md bg-white h-[750px] rounded-[2.5rem] shadow-2xl overflow-hidden flex flex-col border border-gray-100">
        
        <div id="loginView" class="p-10 flex-1 flex flex-col justify-center animate-fade-in">
            <div class="text-center mb-10">
                <div class="inline-block p-4 bg-emerald-50 rounded-3xl mb-4 text-3xl">ğŸ”“</div>
                <h1 class="text-3xl font-bold text-gray-900">ë¡œê·¸ì¸</h1>
                <p class="text-gray-500 mt-2">ë“±ë¡ëœ ê³„ì •ìœ¼ë¡œ ì ‘ì†í•˜ì„¸ìš”.</p>
            </div>
            <div class="space-y-4">
                <input type="text" id="loginId" placeholder="ì•„ì´ë””" class="w-full p-4 bg-gray-50 border-none rounded-2xl outline-none focus:ring-2 focus:ring-emerald-500 transition-all">
                <input type="password" id="loginPw" placeholder="ë¹„ë°€ë²ˆí˜¸" class="w-full p-4 bg-gray-50 border-none rounded-2xl outline-none focus:ring-2 focus:ring-emerald-500 transition-all">
                <button onclick="doLogin()" class="w-full py-4 bg-emerald-500 text-white font-bold rounded-2xl shadow-lg active:scale-95 transition-all">ì ‘ì†í•˜ê¸°</button>
                <button onclick="showSignup()" class="w-full py-4 text-emerald-600 font-semibold mt-2 hover:bg-emerald-50 rounded-2xl">ê³„ì •ì´ ì—†ìœ¼ì‹ ê°€ìš”? íšŒì›ê°€ì…</button>
            </div>
        </div>

        <div id="signupView" class="hidden p-10 flex-1 flex flex-col justify-center animate-fade-in">
            <div class="text-center mb-10">
                <div class="inline-block p-4 bg-blue-50 rounded-3xl mb-4 text-3xl">ğŸ“</div>
                <h1 class="text-3xl font-bold text-gray-900">íšŒì›ê°€ì…</h1>
                <p class="text-gray-500 mt-2">ìƒˆë¡œìš´ ê³„ì •ì„ ìƒì„±í•©ë‹ˆë‹¤.</p>
            </div>
            <div class="space-y-4">
                <input type="text" id="signupId" placeholder="ìƒˆ ì•„ì´ë””" class="w-full p-4 bg-gray-50 border-none rounded-2xl outline-none focus:ring-2 focus:ring-blue-500 transition-all">
                <input type="password" id="signupPw" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸" class="w-full p-4 bg-gray-50 border-none rounded-2xl outline-none focus:ring-2 focus:ring-blue-500 transition-all">
                <button onclick="doSignup()" class="w-full py-4 bg-blue-500 text-white font-bold rounded-2xl shadow-lg active:scale-95 transition-all">ê°€ì… ì™„ë£Œ</button>
                <button onclick="showLogin()" class="w-full py-4 text-blue-600 font-semibold mt-2 hover:bg-blue-50 rounded-2xl">ì´ë¯¸ ê³„ì •ì´ ìˆë‚˜ìš”? ë¡œê·¸ì¸</button>
            </div>
        </div>

        <div id="chatMainView" class="hidden flex flex-col h-full">
            <header class="p-6 border-b flex justify-between items-center bg-white">
                <h2 id="displayId" class="text-xl font-bold text-gray-800 italic">User</h2>
                <button onclick="logout()" class="text-xs font-bold text-rose-500 bg-rose-50 px-3 py-2 rounded-xl">ë¡œê·¸ì•„ì›ƒ</button>
            </header>
            <div id="chatBox" class="flex-1 p-5 overflow-y-auto space-y-4 bg-slate-50 flex flex-col"></div>
            <div class="p-4 bg-white border-t flex gap-2">
                <input type="text" id="chatInput" placeholder="ë©”ì‹œì§€ ì…ë ¥..." class="flex-1 p-3 bg-gray-100 rounded-2xl outline-none focus:ring-2 focus:ring-emerald-500" onkeypress="if(event.keyCode==13) sendChat()">
                <button onclick="sendChat()" class="bg-emerald-500 text-white px-6 py-3 rounded-2xl font-bold">ì „ì†¡</button>
            </div>
        </div>
    </div>

    <script>
        // Supabase ì—°ê²° ì„¤ì • (ì œê³µí•´ì£¼ì‹  ì •ë³´)
        const SB_URL = 'https://quqnmzarcrhwbdokfsgz.supabase.co'; 
        const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF1cW5temFyY3Jod2Jkb2tmc2d6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY1MTc3ODQsImV4cCI6MjA4MjA5Mzc4NH0.ZBjfXMX3bKk6vJRmsb49MkV3Lq-O5stujPWk_44-kdc';
        const supabase = supabase.createClient(SB_URL, SB_KEY);

        let currentUser = localStorage.getItem("sb_user");
        if(currentUser) goToChat();

        // --- í™”ë©´ ì „í™˜ í•¨ìˆ˜ ---
        function showSignup() {
            document.getElementById('loginView').classList.add('hidden');
            document.getElementById('signupView').classList.remove('hidden');
        }

        function showLogin() {
            document.getElementById('signupView').classList.add('hidden');
            document.getElementById('loginView').classList.remove('hidden');
        }

        function goToChat() {
            document.getElementById('loginView').classList.add('hidden');
            document.getElementById('signupView').classList.add('hidden');
            document.getElementById('chatMainView').classList.remove('hidden');
            document.getElementById('displayId').innerText = currentUser;
            initChat();
        }

        // --- ê¸°ëŠ¥ í•¨ìˆ˜ ---
        async function doSignup() {
            const id = document.getElementById('signupId').value;
            const pw = document.getElementById('signupPw').value;
            if(!id || !pw) return alert("ì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");

            const { data: exist } = await supabase.from('profiles').select('*').eq('username', id);
            if(exist && exist.length > 0) return alert("ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì•„ì´ë””ì…ë‹ˆë‹¤.");

            const { error } = await supabase.from('profiles').insert([{ username: id, password: pw }]);
            if(!error) {
                alert("ê°€ì… ì„±ê³µ! ë¡œê·¸ì¸ í•´ì£¼ì„¸ìš”.");
                showLogin();
            } else {
                alert("ì˜¤ë¥˜: " + error.message);
            }
        }

        async function doLogin() {
            const id = document.getElementById('loginId').value;
            const pw = document.getElementById('loginPw').value;
            const { data } = await supabase.from('profiles').select('*').eq('username', id).eq('password', pw);
            if(data && data.length > 0) {
                currentUser = id;
                localStorage.setItem("sb_user", id);
                goToChat();
            } else {
                alert("ì •ë³´ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
            }
        }

        // --- ì±„íŒ… ë¡œì§ ---
        function initChat() {
            loadHistory();
            supabase.channel('messages_realtime').on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, p => render(p.new)).subscribe();
        }

        async function loadHistory() {
            const { data } = await supabase.from('messages').select('*').order('created_at', { ascending: true });
            if(data) data.forEach(render);
        }

        async function sendChat() {
            const el = document.getElementById('chatInput');
            if(!el.value.trim()) return;
            await supabase.from('messages').insert([{ username: currentUser, content: el.value }]);
            el.value = '';
        }

        function render(m) {
            const box = document.getElementById('chatBox');
            const isMe = m.username === currentUser;
            const div = document.createElement('div');
            div.className = `flex flex-col ${isMe ? 'items-end' : 'items-start'} mb-2`;
            div.innerHTML = `<span class="text-[10px] text-gray-400 mb-1 px-1">${m.username}</span><div class="${isMe ? 'bg-emerald-500 text-white' : 'bg-white text-gray-800'} p-3 rounded-2xl text-sm shadow-sm max-w-[85%]">${m.content}</div>`;
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
        }

        function logout() { localStorage.removeItem("sb_user"); location.reload(); }
    </script>
</body>
</html>
